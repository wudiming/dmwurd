# .github/workflows/rdproaction.yaml

name: æ„å»º RustDesk-Pro

on:
  workflow_dispatch: # å…è®¸è¢«å…¶ä»– workflow è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘

jobs:
  build-rustdesk-pro:
    runs-on: ubuntu-latest

    env:
      LOCAL_TAG_FILE: temp/tag.md

    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }} # ä½¿ç”¨ PAT ä»¥ä¾¿åç»­å¯ä»¥æ¨é€

      - name: è·å–è¿œç¨‹æœ€æ–°ç‰ˆæœ¬å·
        id: get-tag
        run: |
          latest_tag=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/releases/latest | jq -r .tag_name)
          echo "ğŸŒ è¿œç¨‹æœ€æ–°ç‰ˆæœ¬: $latest_tag"
          echo "remote_tag=$latest_tag" >> $GITHUB_ENV

      - name: ğŸ“¦ è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: ğŸ“ å…‹éš† rustdesk ä»“åº“åŠå­æ¨¡å—
        run: git clone --recurse-submodules https://github.com/rustdesk/rustdesk.git

      - name: ğŸ§¹ ç§»é™¤å¹¶é‡æ–°å…‹éš† hbb_common å­æ¨¡å—
        run: |
          cd rustdesk
          SUBMODULE_PATH=$(git config -f .gitmodules --get submodule.libs/hbb_common.path)
          SUBMODULE_URL=$(git config -f .gitmodules --get submodule.libs/hbb_common.url)
          git submodule deinit -f $SUBMODULE_PATH
          git rm --cached $SUBMODULE_PATH
          rm -rf $SUBMODULE_PATH
          git clone $SUBMODULE_URL $SUBMODULE_PATH
          rm -rf libs/hbb_common/.git

      - name: ğŸ”§ ä¿®æ”¹é…ç½®æ–‡ä»¶ (config.rs, common.rs, flutter ymls)
        run: |
          python3 python/reconfig.py rustdesk/libs/hbb_common/src/config.rs
          python3 python/recommon.py rustdesk/src/common.rs
          python3 python/reflutterb.py rustdesk/.github/workflows/flutter-build.yml
          python3 python/reflutterc.py rustdesk/.github/workflows/flutter-ci.yml
        env:
          remote_tag: ${{ env.remote_tag }}

      - name: ğŸ“ æäº¤å¹¶æ¨é€ä¿®æ”¹åˆ°å½“å‰ä»“åº“
        run: |
          cd rustdesk
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
          git checkout $DEFAULT_BRANCH
          git add .
          git commit -m "ğŸ¤– [Automated] Build RustDesk-Pro v${{ env.remote_tag }}"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} $DEFAULT_BRANCH

      - name: â±ï¸ ç­‰å¾… 3 åˆ†é’Ÿè®© CI å¼€å§‹
        run: sleep 180

      - name: ğŸ•µï¸ ç­‰å¾… flutter-ci.yml å®Œæˆ
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq gh
          gh auth setup-git
          
          repo="${{ github.repository }}"
          wf_path=".github/workflows/flutter-ci.yml"
          
          echo "ğŸ” æŸ¥è¯¢ flutter-ci.yml çš„ workflow id..."
          wf_id=$(gh api repos/$repo/actions/workflows | jq -r ".workflows[] | select(.path == \"$wf_path\") | .id")
          if [ -z "$wf_id" ]; then
            echo "âŒ æ‰¾ä¸åˆ° flutter-ci.yml çš„ workflow"
            exit 1
          fi
          
          echo "â³ ç­‰å¾… flutter-ci.yml æ‰§è¡Œå®Œæˆ..."
          timeout 3600s bash -c '
            while true; do
              status=$(gh api "repos/'"$repo"'/actions/workflows/'"$wf_id"'/runs?branch=master&per_page=1" | jq -r ".workflow_runs[0].status")
              conclusion=$(gh api "repos/'"$repo"'/actions/workflows/'"$wf_id"'/runs?branch=master&per_page=1" | jq -r ".workflow_runs[0].conclusion")
              echo "ğŸ”„ å½“å‰çŠ¶æ€: $status, ç»“æœ: $conclusion"
              if [ "$status" == "completed" ]; then
                if [ "$conclusion" == "success" ]; then
                  echo "âœ… flutter-ci.yml æ‰§è¡ŒæˆåŠŸ"
                  break
                else
                  echo "âŒ flutter-ci.yml æ‰§è¡Œå¤±è´¥ ($conclusion)"
                  exit 1
                fi
              fi
              echo "ğŸ•’ ç­‰å¾… 5 åˆ†é’Ÿåé‡è¯•..."
              sleep 300
            done
          '

      - name: ğŸ”¥ åˆ é™¤ master åˆ†æ”¯
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ğŸ—‘ï¸ å‡†å¤‡åˆ é™¤ master åˆ†æ”¯..."
          if git ls-remote --exit-code --heads https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} master; then
            git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} --delete master
            echo "âœ… å·²åˆ é™¤ master åˆ†é’Ÿ"
          else
            echo "â„¹ï¸ master åˆ†æ”¯ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
          fi

      - name: ğŸ“ğŸ“Œ å†™å…¥å¹¶æäº¤æ–°ç‰ˆæœ¬å·
        run: |
          mkdir -p temp
          echo "${{ env.remote_tag }}" > $LOCAL_TAG_FILE
          echo "âœ… å·²å°†æœ€æ–°ç‰ˆæœ¬å· ${{ env.remote_tag }} å†™å…¥åˆ° $LOCAL_TAG_FILE"
          
          git add $LOCAL_TAG_FILE
          # git diff --staged --quiet || git commit -m "ğŸ”– Chore: æ›´æ–°æœ¬åœ°ç‰ˆæœ¬å·ä¸º ${{ env.remote_tag }}"
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ”– Chore: æ›´æ–°æœ¬åœ°ç‰ˆæœ¬å·ä¸º ${{ env.remote_tag }}"
            git push
          else
            echo "â„¹ï¸ ç‰ˆæœ¬æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          fi
