name: æ„å»º RustDesk-Pro

on:
  workflow_dispatch: # å…è®¸è¢«å…¶ä»– workflow è§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘

jobs:
  build-rustdesk-pro:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ env.GH_TOKEN }}

      - name: è·å–è¿œç¨‹æœ€æ–°ç‰ˆæœ¬å·
        id: get-tag
        run: |
          latest_tag=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/releases/latest | jq -r .tag_name)
          echo "ğŸŒ è¿œç¨‹æœ€æ–°ç‰ˆæœ¬: $latest_tag"
          # ä½¿ç”¨ GITHUB_ENV å°†åŠ¨æ€ç”Ÿæˆçš„å˜é‡ä¼ é€’ç»™åç»­æ­¥éª¤
          echo "remote_tag=$latest_tag" >> $GITHUB_ENV

      - name: ğŸ“¦ è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: ğŸ“ å…‹éš† rustdesk ä»“åº“åŠå­æ¨¡å—
        run: git clone --recurse-submodules https://github.com/rustdesk/rustdesk.git

      - name: ğŸ§¹ ç§»é™¤å¹¶é‡æ–°å…‹éš† hbb_common å­æ¨¡å—
        run: |
          cd rustdesk
          SUBMODULE_PATH=$(git config -f .gitmodules --get submodule.libs/hbb_common.path)
          SUBMODULE_URL=$(git config -f .gitmodules --get submodule.libs/hbb_common.url)
          git submodule deinit -f $SUBMODULE_PATH
          git rm --cached $SUBMODULE_PATH
          rm -rf $SUBMODULE_PATH
          git clone $SUBMODULE_URL $SUBMODULE_PATH
          rm -rf libs/hbb_common/.git

      - name: ğŸ”§ ä¿®æ”¹é…ç½®æ–‡ä»¶ (config.rs, common.rs, flutter)
        run: |
          # python è„šæœ¬ä¼šè‡ªåŠ¨ä»ç¯å¢ƒä¸­è¯»å– remote_tag å˜é‡
          python3 python/reconfig.py rustdesk/libs/hbb_common/src/config.rs
          python3 python/recommon.py rustdesk/src/common.rs
          python3 python/refluttera.py rustdesk/.github/workflows/flutter-ci.yml
          python3 python/redarta.py rustdesk/flutter/lib/mobile/pages/connection_page.dart
          python3 python/redartb.py rustdesk/flutter/lib/desktop/pages/desktop_home_page.dart

      - name: ğŸ“ æäº¤å¹¶æ¨é€ä¿®æ”¹åˆ°å½“å‰ä»“åº“
        run: |
          cd rustdesk
          TARGET_BRANCH="master"
          if ! git show-ref --verify --quiet refs/heads/$TARGET_BRANCH; then
            git checkout -b $TARGET_BRANCH
          else
            git checkout $TARGET_BRANCH
          fi
          git add .
          git commit --allow-empty -m "Build RustDesk-Pro v${{ env.remote_tag }}"
          git push https://x-access-token:${{ env.GH_TOKEN }}@github.com/${{ github.repository }} $TARGET_BRANCH

      - name: â±ï¸ ç­‰å¾… 3 åˆ†é’Ÿè®© CI å¼€å§‹
        run: sleep 180

      - name: ğŸ•µï¸ ç­‰å¾… flutter-ci.yml å®Œæˆ
        run: |
          sudo apt-get update && sudo apt-get install -y jq gh
          gh auth setup-git
          
          repo="${{ github.repository }}"
          wf_path=".github/workflows/flutter-ci.yml"
          target_branch="master"
          
          echo "ğŸ” æŸ¥è¯¢ flutter-ci.yml çš„ workflow id..."
          wf_id=$(gh api repos/$repo/actions/workflows | jq -r ".workflows[] | select(.path == \"$wf_path\") | .id")
          if [ -z "$wf_id" ]; then
            echo "âŒ æ‰¾ä¸åˆ° flutter-ci.yml çš„ workflow"
            exit 1
          fi
          
          echo "â³ ç­‰å¾… flutter-ci.yml åœ¨åˆ†æ”¯ '$target_branch' ä¸Šæ‰§è¡Œå®Œæˆ..."
          timeout 7200s bash -c '
            while true; do
              run_info=$(gh api "repos/'"$repo"'/actions/workflows/'"$wf_id"'/runs?branch='"$target_branch"'&per_page=1")
              status=$(echo "$run_info" | jq -r ".workflow_runs[0].status")
              conclusion=$(echo "$run_info" | jq -r ".workflow_runs[0].conclusion")

              echo "ğŸ”„ å½“å‰çŠ¶æ€: $status, ç»“æœ: $conclusion"
              if [ "$status" == "completed" ]; then
                if [ "$conclusion" == "success" ]; then
                  echo "âœ… flutter-ci.yml æ‰§è¡ŒæˆåŠŸ"
                  break
                else
                  echo "âŒ flutter-ci.yml æ‰§è¡Œå¤±è´¥ ($conclusion)"
                  exit 1
                fi
              fi
              echo "ğŸ•’ ç­‰å¾… 5 åˆ†é’Ÿåé‡è¯•..."
              sleep 300
            done
          '
      
      - name: ğŸš€ å‘å¸ƒ Release
        run: |
          echo "ğŸš€ æ­£åœ¨å°†ç‰ˆæœ¬ ${{ env.remote_tag }} ä» pre-release æ›´æ–°ä¸ºæ­£å¼ release..."
          gh release edit "${{ env.remote_tag }}" \
            --repo "${{ github.repository }}" \
            --prerelease=false
            
          echo "âœ… ç‰ˆæœ¬ ${{ env.remote_tag }} å·²æˆåŠŸå‘å¸ƒï¼"

      - name: ğŸ”¥ åˆ é™¤ master åˆ†æ”¯
        run: |
          echo "ğŸ—‘ï¸ å‡†å¤‡åˆ é™¤ master åˆ†æ”¯..."
          if git ls-remote --exit-code --heads https://x-access-token:${{ env.GH_TOKEN }}@github.com/${{ github.repository }} master; then
            git push https://x-access-token:${{ env.GH_TOKEN }}@github.com/${{ github.repository }} --delete master
            echo "âœ… å·²åˆ é™¤ master åˆ†æ”¯"
          else
            echo "â„¹ï¸ master åˆ†æ”¯ä¸å­˜åœ¨æˆ–å·²åˆ é™¤"
          fi
