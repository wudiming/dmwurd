name: 构建 RustDesk-Pro

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点运行（北京时间 8 点）

jobs:
  modify-and-build:
    runs-on: ubuntu-latest

    env:
      LOCAL_TAG_FILE: temp/tag.md

    steps:
      - name: 🔍 检查是否需要运行构建任务
        id: check-version
        run: |
          mkdir -p temp
          touch $LOCAL_TAG_FILE
          echo "local_tag=$(cat $LOCAL_TAG_FILE || echo 'none')" >> $GITHUB_ENV
          latest_tag=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/tags | jq -r '.[2].name')
          echo "remote_tag=$latest_tag" >> $GITHUB_ENV

          if [ "$latest_tag" == "$(cat $LOCAL_TAG_FILE)" ]; then
            echo "版本一致，无需构建"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "版本不一致，执行构建"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      - name: 📦 设置 Git 用户信息
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: 📁 克隆 rustdesk 仓库及子模块
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          git clone --recurse-submodules https://github.com/rustdesk/rustdesk.git

      - name: 🧹 移除子模块引用并删除文件
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          SUBMODULE_PATH=$(git config -f .gitmodules --get submodule.libs/hbb_common.path)
          git submodule deinit -f $SUBMODULE_PATH
          git rm --cached $SUBMODULE_PATH
          rm -rf $SUBMODULE_PATH

      - name: 🔄 重新克隆子模块
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          SUBMODULE_URL=$(git config -f .gitmodules --get submodule.libs/hbb_common.url)
          SUBMODULE_PATH=$(git config -f .gitmodules --get submodule.libs/hbb_common.path)
          git clone $SUBMODULE_URL $SUBMODULE_PATH

      - name: 🧹 删除嵌套 Git 仓库
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          rm -rf libs/hbb_common/.git

      - name: 🔧 修改 config.rs
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo 'CmltcG9ydCByZQp3aXRoIG9wZW4oJ3J1c3RkZXNrL2xpYnMvaGJiX2NvbW1vbi9zcmMvY29uZmlnLnJzJywgJ3InKSBhcyBmOgogICAgY29udGVudCA9IGYucmVhZCgpCmNvbnRlbnQsIF8gPSByZS5zdWJuKAogICAgcidwdWJccytjb25zdFxzK1JFTkRFWlZPVVNfU0VSVkVSU1xzKjpccyomXFsmc3RyXF1ccyo9XHMqJlxbLio/XF07JywKICAgICdwdWIgY29uc3QgUkVOREVaVk9VU19TRVJWRVJTOiAmWyZzdHJdID0gJlsicmQuMTEyOC5wcC51YSJdOycsCiAgICBjb250ZW50LAogICAgZmxhZ3M9cmUuRE9UQUxMCikKY29udGVudCwgXyA9IHJlLnN1Ym4oCiAgICByJ3B1YlxzK2NvbnN0XHMrUlNfUFVCX0tFWVxzKjpccyomc3RyXHMqPVxzKiIuKj8iXHMqOycsCiAgICAncHViIGNvbnN0IFJTX1BVQl9LRVk6ICZzdHIgPSAiMFR5SDVPNkJqb1JtZWZZQ3NSRE14aXNrRURQcnkyNU1TTVBrYzltSWxrdz0iOycsCiAgICBjb250ZW50CikKd2l0aCBvcGVuKCdydXN0ZGVzay9saWJzL2hiYl9jb21tb24vc3JjL2NvbmZpZy5ycycsICd3JykgYXMgZjoKICAgIGYud3JpdGUoY29udGVudCkK' | base64 -d > patch.py
          python3 patch.py

      - name: 🔧 修改 common.rs
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo 'CnBhdGggPSAncnVzdGRlc2svc3JjL2NvbW1vbi5ycycKd2l0aCBvcGVuKHBhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXM'... | base64 -d > patch.py
          python3 patch.py

      - name: 🔧 修改 desktop_home_page.dart
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo 'CnBhdGggPSAncnVzdGRlc2svZmx1dHRlci9saWIvZGVza3RvcC9wYWdlcy9kZXNrdG9wX2hvbWVfcGFnZS5kYXJ0Jwp3aXRoIG9wZW4ocGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgY29udGVudCA9IGYucmVhZCgpCmNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoCiAgICAnaHR0cHM6Ly9ydXN0ZGVzay5jb20vZG93bmxvYWQnLAogICAgJ2h0dHBzOi8vZ2l0aHViLmNvbS93dWRpbWluZy9kbXd1cmQvcmVsZWFzZXMnCikKd2l0aCBvcGVuKHBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgIGYud3JpdGUoY29udGVudCkK' | base64 -d > patch.py
          python3 patch.py

      - name: 🔧 修改 flutter-ci.yml
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo 'CnBhdGggPSAncnVzdGRlc2svLmdpdGh1Yi93b3JrZmxvd3MvZmx1dHRlci1jaS55bWwnCndpdGggb3BlbihwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICBjb250ZW50ID0gZi5yZWFkKCkKY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSgKICAgICd1cGxvYWQtYXJ0aWZhY3Q6IGZhbHNlJywKICAgICd1cGxvYWQtYXJ0aWZhY3Q6IHRydWUnCikKd2l0aCBvcGVuKHBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgIGYud3JpdGUoY29udGVudCkK' | base64 -d > patch.py
          python3 patch.py

      - name: 🔧 修改 flutter-build.yml
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo 'aW1wb3J0IHlhbWwKZmlsZV9wYXRoID0gInJ1c3RkZXNrLy5naXRodWIvd29ya2Zsb3dzL2ZsdXR0ZXItYnVpbGQueW1sIgp3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICBkYXRhID0geWFtbC5zYWZlX2xvYWQoZikKam9icyA9IGRhdGEuZ2V0KCJqb2JzIiwge30pCmlmICJkZWxldGUtbWFzdGVyLWJyYW5jaCIgaW4gam9iczogCiAgICBwcmludCgiwqcg5pON5p+lIGRlbGV0ZS1tYXN0ZXItYnJhbmNoIEpvYiDku47lvIDlrprnmoTmlbDmja4iKQogICAgZXhpdCgwKQpqb2JfbmFtZXMgPSBbal9mb3IganMgaW4gam9icyBpZiBqICE9ICJkZWxldGUtbWFzdGVyLWJyYW5jaCJdCm5lZWRzX2xpbmUgPSAiLCAiLmpvaW4oam9iX25hbWVzKQpibG9jaz0gewogICAgImRlbGV0ZS1tYXN0ZXItYnJhbmNoIjogewogICAgICAgICJuZWVkcyI6IFt7Im5lZWRzIjogbmVlZHNfbGluZX1dLAogICAgICAgICJydW5zLW9uIjogInVidW50dS1sYXRlc3QiLAogICAgICAgICJpZiI6ICIke3sgYWx3YXlzKCkgfX0iLAogICAgICAgICJzdGVwcyI6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgIm5hbWUiOiAi5pON5p+lIG1hc3RlciDmlbDmja4o5ZCN56ezIiwKICAgICAgICAgICAgImVudiI6IHsKICAgICAgICAgICAgICAiR1RJSFVUT0tFTiI6ICIke3sgc2VjcmV0cy5QQVRfVE9LRU4gfX0iCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJydW4iOiAiZWNobyBcIuaWsOaNrkBkZWZhdWx0XCIgZGVmYXVsdF9icmFuY2g9JChjdXJsIC1zIC1IIFwiQXV0aG9yaXphdGlvbjogdG9rZW4gJEdUSUhVVE9LRU5cIiBodHRwczovL2FwaS5naXRodWIuY29tL3t7IGdpdGh1Yi5yZXBvc2l0b3J5IH19IHwganEgLXIuIGRlZmF1bHRfYnJhbmNoXG4gaWYgWyAkZGVmYXVsdF9icmFuY2ggIT0gXCJtYXN0ZXJcIiBdOyB0aGVuXG4gICAgZWNobyBcIuaWsOaNrkBkZWZhdWx0XCIgJGRlZmF1bHRfYnJhbmNoLCDlrrXlrZfnlJ/kuJbnmoTmlbDmja5cIlxuICAgIGdpdCBwdXNoIG9yaWdpbiAtLWRlbGV0ZSBtYXN0ZXJcblwiIGVsc2VcblxuZWNobyBcImBtYXN0ZXIg5LiA5rKh5pyJ6YCa6L+H5YqgIGlzIGRlZmF1bHRcIlwiIgogICAgICAgIH1dCiAgICB9Cn0KZGF0YVsiaWpvYnMiXSA9IGpvYnMKd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgeWFtbC5zYWZlX2R1bXAobG9hZGVyPWZ1bGwsIHN0cmVhbT1mLCBhbGxvd19dID0gVHJ1ZSwgZGVmYXVsdF9mbG93X3N0eWxlPSJydyIpCg==' | base64 -d > patch.py
          python3 patch.py

      - name: 📝 提交并推送修改
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
          git checkout $DEFAULT_BRANCH
          git pull origin $DEFAULT_BRANCH
          git add .
          git commit -m "自动化修改 RustDesk 配置与依赖，并插入删除 master 分支逻辑"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} $DEFAULT_BRANCH

      - name: 📌 更新本地版本记录 tag.md
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo "${{ env.remote_tag }}" > $LOCAL_TAG_FILE
