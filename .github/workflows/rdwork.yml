name: æ„å»º RustDesk-Pro

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 0 ç‚¹ï¼Œå³åŒ—äº¬æ—¶é—´ 8 ç‚¹è¿è¡Œ

jobs:
  modify-and-build:
    runs-on: ubuntu-latest

    env:
      LOCAL_TAG_FILE: temp/tag.md

    steps:
      - name: ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦è¿è¡Œæ„å»ºä»»åŠ¡
        id: check-version
        run: |
          mkdir -p temp
          touch $LOCAL_TAG_FILE
          echo "local_tag=$(cat $LOCAL_TAG_FILE || echo 'none')" >> $GITHUB_ENV
          latest_tag=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/tags | jq -r '.[2].name')
          echo "remote_tag=$latest_tag" >> $GITHUB_ENV

          if [ "$latest_tag" == "$(cat $LOCAL_TAG_FILE)" ]; then
            echo "ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ„å»º"
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæ‰§è¡Œæ„å»º"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: ğŸ“ å…‹éš† rustdesk ä»“åº“åŠå­æ¨¡å—
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          git clone --recurse-submodules https://github.com/rustdesk/rustdesk.git

      - name: ğŸ§¹ ç§»é™¤å­æ¨¡å—å¼•ç”¨å¹¶åˆ é™¤æ–‡ä»¶
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          SUBMODULE_PATH=$(git config -f .gitmodules --get submodule.libs/hbb_common.path)
          git submodule deinit -f $SUBMODULE_PATH
          git rm --cached $SUBMODULE_PATH
          rm -rf $SUBMODULE_PATH

      - name: ğŸ”„ é‡æ–°å…‹éš†å­æ¨¡å—
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          SUBMODULE_URL=$(git config -f .gitmodules --get submodule.libs/hbb_common.url)
          SUBMODULE_PATH=$(git config -f .gitmodules --get submodule.libs/hbb_common.path)
          git clone $SUBMODULE_URL $SUBMODULE_PATH

      - name: ğŸ§¹ åˆ é™¤åµŒå¥— Git ä»“åº“
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          rm -rf libs/hbb_common/.git

      - name: âœï¸ ä¿®æ”¹ config.rs ä¸­çš„æœåŠ¡å™¨å’Œå…¬é’¥
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk/libs/hbb_common/src
          python3 - <<EOF
import re
with open('config.rs', 'r') as f:
    content = f.read()
content, _ = re.subn(
    r'pub\\s+const\\s+RENDEZVOUS_SERVERS\\s*:\\s*&\\[&str\\]\\s*=\\s*&\\[.*?\\];',
    'pub const RENDEZVOUS_SERVERS: &[&str] = &["rd.1128.pp.ua"];',
    content,
    flags=re.DOTALL
)
content, _ = re.subn(
    r'pub\\s+const\\s+RS_PUB_KEY\\s*:\\s*&str\\s*=\\s*".*?"\\s*;',
    'pub const RS_PUB_KEY: &str = "0TyH5O6BjoRmefYCsRDMxiskEDPry25MSMPkc9mIlkw=";',
    content
)
with open('config.rs', 'w') as f:
    f.write(content)
EOF

      - name: âœï¸ ä¿®æ”¹ common.rs ç®¡ç†åœ°å€
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk/src
          sed -i 's|"https://admin.rustdesk.com".to_owned()|"https://rd.1128.pp.ua:21114".to_owned()|g' common.rs

      - name: âœï¸ ä¿®æ”¹ä¸‹è½½é“¾æ¥ desktop_home_page.dart
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk/flutter/lib/desktop/pages
          sed -i "s|https://rustdesk.com/download|https://github.com/wudiming/dmwurd/releases|g" desktop_home_page.dart

      - name: âœï¸ ä¿®æ”¹ flutter-ci.yml ä¸Šä¼ è®¾ç½®
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk/.github/workflows
          sed -i 's/upload-artifact: false/upload-artifact: true/g' flutter-ci.yml

      - name: â• è‡ªåŠ¨æ’å…¥åˆ é™¤ master åˆ†æ”¯ Jobï¼ˆä¾èµ–æ‰€æœ‰å…¶ä»– Jobï¼‰
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk/.github/workflows
          python3 - <<"EOF"
import yaml
import re

file_path = "flutter-build.yml"
with open(file_path, "r", encoding="utf-8") as f:
    data = yaml.safe_load(f)

jobs = data.get("jobs", {})
if "delete-master-branch" in jobs:
    print("âš ï¸ å·²å­˜åœ¨ delete-master-branch Jobï¼Œè·³è¿‡æ’å…¥")
    exit(0)

job_names = [j for j in jobs if j != "delete-master-branch"]
needs_line = ", ".join(job_names)

block = f"""
  delete-master-branch:
    needs: [{needs_line}]
    runs-on: ubuntu-latest
    if: ${{{{ always() }}}}
    steps:
      - name: åˆ é™¤ master åˆ†æ”¯ï¼ˆè‹¥ä¸æ˜¯é»˜è®¤åˆ†æ”¯ï¼‰
        env:
          GITHUB_TOKEN: ${{{{ secrets.PAT_TOKEN }}}}
        run: |
          echo "æ£€æŸ¥é»˜è®¤åˆ†æ”¯..."
          default_branch=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/${{{{ github.repository }}}} | jq -r .default_branch)
          if [ "$default_branch" != "master" ]; then
            echo "é»˜è®¤åˆ†æ”¯ä¸º $default_branchï¼Œå…è®¸åˆ é™¤ master"
            git push origin --delete master
          else
            echo "âš ï¸ master æ˜¯é»˜è®¤åˆ†æ”¯ï¼Œä¸èƒ½åˆ é™¤"
          fi
"""

# ä¿®å¤YAMLæ ¼å¼é—®é¢˜
block = re.sub(r'(\${{)', r'$\1', block)

with open(file_path, "r", encoding="utf-8") as f:
    lines = f.readlines()

insert_index = None
for i, line in enumerate(lines):
    if line.startswith("jobs:") and i < len(lines) - 1:
        insert_index = i + 1
        break

if insert_index is None:
    print("âŒ æœªæ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®")
    exit(1)

lines.insert(insert_index, block + "\n")

with open(file_path, "w", encoding="utf-8") as f:
    f.writelines(lines)

print("âœ… æ’å…¥æˆåŠŸ")
EOF

      - name: ğŸ“ æäº¤å¹¶æ¨é€ä¿®æ”¹
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          cd rustdesk
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
          git checkout $DEFAULT_BRANCH
          git pull origin $DEFAULT_BRANCH
          git add .
          git commit -m "è‡ªåŠ¨åŒ–ä¿®æ”¹ RustDesk é…ç½®ä¸ä¾èµ–ï¼Œå¹¶æ’å…¥åˆ é™¤ master åˆ†æ”¯é€»è¾‘"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }} $DEFAULT_BRANCH

      - name: ğŸ“Œ æ›´æ–°æœ¬åœ°ç‰ˆæœ¬è®°å½• tag.md
        if: steps.check-version.outputs.skip_build == 'false'
        run: |
          echo "${{ env.remote_tag }}" > $LOCAL_TAG_FILE
